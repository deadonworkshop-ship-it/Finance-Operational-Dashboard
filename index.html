<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bills Checking Ops</title>
<link rel="manifest" href="manifest.json">
<style>
body{margin:0;font-family:-apple-system,system-ui;background:#0b0f14;color:#fff;}

.btn{
  border:1px solid #2aa6ff;
  background:#0c131d;
  color:white;
  padding:18px 16px;
  border-radius:14px;
  font-size:18px;
  font-weight:800;
  width:100%;
  min-height:64px;
  margin-top:10px;
}

.confirmBar{
  display:none;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid #1b2533;
}

.confirmBtn{
  background:#18232f;
  color:white;
  border:1px solid #2aa6ff55;
  padding:14px;
  border-radius:12px;
  font-weight:800;
  width:45%;
  margin-right:8px;
}

/* Slide-left + fade out (checklist clear) */
.item.removing{
  animation: slideOut 220ms ease-in forwards;
}

@keyframes slideOut{
  from { transform: translateX(0); opacity:1; }
  to   { transform: translateX(-22px); opacity:0; }
}

.cancelBtn{
  background:#141a22;
  color:#9aa7b6;
  border:1px solid #1b2533;
  padding:14px;
  border-radius:12px;
  width:25%;
}

/* ===== BEGIN EDIT BUTTON ===== */
.editBtn{
  background:#141a22;
  color:#c6d0db;
  border:1px solid #1b2533;
  padding:14px;
  border-radius:12px;
  width:25%;
}
/* ===== END EDIT BUTTON ===== */

/* ===== BEGIN BILLS PAID STATE (REVERSIBLE) ===== */
.item.paid{
  opacity: 0.55;
}
.item.paid > div:first-child{
  text-decoration: line-through;
  color: #9aa7b6;
}
/* ===== END BILLS PAID STATE (REVERSIBLE) ===== */

.item .confirmBar{
  animation: dropIn 160ms ease-out;
}

@keyframes dropIn{
  from { transform: translateY(-6px); opacity:0; }
  to   { transform: translateY(0); opacity:1; }
}

.header{display:flex;align-items:center;padding:14px;border-bottom:1px solid #1b2533;}
.menu{font-size:22px;margin-right:12px;}
.container{padding:18px;}
.card{background:#101722;border:1px solid #1b2533;border-radius:14px;padding:18px;margin-bottom:14px;}
.big{font-size:42px;font-weight:800;}
.row{display:flex;justify-content:space-between;margin-top:12px;font-size:16px;}
.list{background:#101722;border:1px solid #1b2533;border-radius:14px;}
.item{display:flex;justify-content:space-between;padding:14px;border-top:1px solid #1b2533;}
.item:first-child{border-top:none;}
.one{color:#f5b942;}

/* ===== BEGIN MOBILE FIX: debt form stacks vertically ===== */

/* Prevent any accidental horizontal scroll */
html, body { overflow-x: hidden; }

@media (max-width: 520px){
  #debtForm{
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  #debtCardSelect,
  #debtAmountInput{
    width: 100% !important;
    box-sizing: border-box;
  }

  #debtForm .confirmBtn,
  #debtForm .cancelBtn{
    width: 100%;
  }

  /* Optional: put ADD/CANCEL on one row instead of full width */
  /* 
  #debtForm .confirmBtn, #debtForm .cancelBtn { width: 49%; }
  #debtForm { flex-direction: column; }
  */
}
/* ===== END MOBILE FIX: debt form stacks vertically ===== */

/* ===== BEGIN MOBILE FIX: debt snapshot controls stack vertically ===== */
@media (max-width: 520px){
  #debtSnapshotControls{
    flex-direction: column;
    align-items: stretch;
  }

  #debtSnapshotSelect,
  #debtSnapshotInput{
    width: 100% !important;
    box-sizing: border-box;
    font-size: 16px; /* prevents iOS zoom/focus weirdness */
  }

  #debtSnapshotControls .confirmBtn{
    width: 100% !important;
  }
}
/* ===== END MOBILE FIX: debt snapshot controls stack vertically ===== */

/* ===== BEGIN MONTHLY BILLS PAGE STYLES ===== */
.billControls{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}

.billControls input[type="date"]{
  background:#0c131d;
  color:#fff;
  border:1px solid #1b2533;
  border-radius:12px;
  padding:10px 12px;
  font-size:14px;
}

.billControls .miniBtn{
  background:#141a22;
  color:#9aa7b6;
  border:1px solid #1b2533;
  padding:10px 12px;
  border-radius:12px;
  font-weight:800;
}

.billControls label{
  display:flex;
  gap:8px;
  align-items:center;
  font-weight:800;
}

@media (max-width: 520px){
  .billControls{
    justify-content:space-between;
  }
  .billControls input[type="date"]{
    width: 100%;
  }
}
/* ===== END MONTHLY BILLS PAGE STYLES ===== */

/* ===== BILL PAID TOGGLE BUTTON ===== */
.billPaidBtn{
  min-width: 120px;
  padding: 14px 16px;
  border-radius: 14px;
  font-weight: 800;
  border: 1px solid #1b2533;
  background: #141a22;
  color: #fff;
}

.billPaidBtn.paid{
  background: #0f141b;
  color: #9aa7b6;
  border-color: #2a3443;
}
/* ================================= */


</style>

</head>
<body>
<div class="header">
  <div class="menu" id="menuBtn" onclick="toggleMenu()">☰</div>
  <div>Phase 1 Bills Checking (v2)</div>
</div>

<!-- ===== BEGIN MENU DRAWER ===== -->
<div id="menuBackdrop" onclick="toggleMenu()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:50;"></div>

<div id="menuDrawer" style="
  display:none;
  position:fixed; top:0; left:0; height:100vh; width:min(360px, 86vw);
  background:#0c131d; border-right:1px solid #1b2533;
  z-index:60; padding:14px; overflow:auto;
">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <div style="font-weight:800;">MENU</div>
    <button class="cancelBtn" onclick="toggleMenu()" style="width:auto; padding:10px 12px;">CLOSE</button>
  </div>

  <!-- Section: Debt Snapshot -->
  <div class="card" style="margin-bottom:14px;">
  <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Navigate</div>

  <div class="list">
    <div class="item" style="cursor:pointer;" onclick="navigateTo('home')">
      <div>Home</div><div>›</div>
    </div>
    <div class="item" style="cursor:pointer;" onclick="navigateTo('debt')">
      <div>Debt Snapshot</div><div>›</div>
    </div>
    <div class="item" style="cursor:pointer;" onclick="navigateTo('bills')">
      <div>Monthly Bills</div><div>›</div>
    </div>
  </div>
</div>


  <!-- Section: Monthly Bills -->
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Monthly Bills</div>

    <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
      <select id="billMonthSelect" style="flex:1; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;">
        <option value="2026-02">2026-02</option>
        <option value="2026-01">2026-01</option>
        <option value="2025-12">2025-12</option>
      </select>

      <button class="confirmBtn" onclick="renderMonthlyBills()" style="width:auto;">VIEW</button>
    </div>

    <div class="list" id="monthlyBillsList"></div>
  </div>
</div>
<!-- ===== END MENU DRAWER ===== -->

<!-- ===== BEGIN PAGE HOME WRAPPER ===== -->
<div class="container page" id="pageHome">

<div class="card">
<div style="font-size:12px;color:#9aa7b6;">YOU SHOULD HAVE</div>
<div class="big" id="shouldHave">$546.56</div>

<div style="margin-top:14px;">
  <div style="font-size:12px;color:#9aa7b6;">CURRENT BALANCE</div>

  <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:10px;">
    <div style="text-align:left;padding-right:18px;">
      <div id="currentBalance" style="font-size:26px;font-weight:800;">$1,344.59</div>
      <div id="updatedAgo" style="font-size:13px;color:#f5b942;margin-top:4px;">UPDATED —</div>

    </div>

    <button class="btn" onclick="updateBalance()" style="margin-left:10px;">
      UPDATE
    </button>
  </div>
</div>

<div class="row">
<div>AVAILABLE FOR DEBT</div>
<div id="avail">$798.03</div>
</div>

<div class="row">
  <div>STATUS</div>
  <div id="statusText" style="color:#9aa7b6;">—</div>
</div>

</div>

<div class="card">
  <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Quick Actions</div>
  <button class="btn" onclick="showDebtForm()">Add Debt Payment</button>
  <button class="btn">Add One-Time Bill</button>
  <button class="btn">Flip Phase</button>
</div>

<!-- ===== BEGIN DEBT PAYMENTS LIST ===== -->
<div class="card">
  <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Debt Payments</div>

  <!-- Inline add form (hidden until you tap Add Debt Payment) -->
  <div id="debtForm" style="display:none; gap:10px; align-items:center; margin-bottom:12px;">
    <select id="debtCardSelect" style="flex:1; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;">
      <!-- options populated by JS -->
    </select>

    <input id="debtAmountInput"
       inputmode="decimal"
       placeholder="$0.00"
       oninput="autoFormatCurrencyInput(this)"
       onblur="finalizeCurrencyInput(this)"
       style="width:140px; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;" />

    <button class="confirmBtn" onclick="addDebtPaymentFromForm()">ADD</button>
    <button class="cancelBtn" onclick="hideDebtForm()">CANCEL</button>
  </div>

  <div class="list" id="debtList"></div>
</div>
<!-- ===== END DEBT PAYMENTS LIST ===== -->



<div class="list" id="billsList">
<div class="item" data-amount="229.03" data-date="2026-02-05" onclick="toggleConfirm(this)">

  <div>Car Payment - Highlander</div>
  <div>$229.03</div>

  <div class="confirmBar">
    <button class="confirmBtn" onclick="confirmPaid(event,this)">✔ CONFIRM PAID</button>
    <button class="cancelBtn" onclick="cancelConfirm(event,this)">CANCEL</button>
  </div>
</div>

<div class="item" data-amount="569.00" data-date="2026-02-05" onclick="toggleConfirm(this)">
  <div>Car Payment - Tesla</div>
  <div>$569.00</div>

  <div class="confirmBar">
    <button class="confirmBtn" onclick="confirmPaid(event,this)">✔ CONFIRM PAID</button>
    <button class="cancelBtn" onclick="cancelConfirm(event,this)">CANCEL</button>
  </div>
</div>

</div>

</div>
<!-- ===== END PAGE HOME WRAPPER ===== -->

<!-- ===== BEGIN DEBT SNAPSHOT PAGE ===== -->
<div class="container page" id="pageDebt" style="display:none;">

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-weight:800;">Debt Snapshot</div>
      <button class="cancelBtn" onclick="navigateTo('home')" style="width:auto; padding:10px 12px;">BACK</button>
    </div>
    <div style="font-size:12px;color:#9aa7b6;margin-top:6px;">
  Update balances manually. Optional: auto-apply confirmed payments to reduce balances.
</div>

<div class="row" style="margin-top:12px;">
  <div>AUTO-APPLY PAYMENTS</div>
  <label style="display:flex;align-items:center;gap:10px;">
    <input id="autoApplyToggle" type="checkbox" onchange="onToggleAutoApply(this.checked)" />
    <span style="color:#9aa7b6;font-size:13px;">ON/OFF</span>
  </label>
</div>

<div class="row" style="margin-top:12px;">
  <div>TOTAL DEBT OWED</div>
  <div id="totalDebtOwed" style="font-weight:800;">$0</div>
</div>

  </div>


  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Select Debt</div>

    <div id="debtSnapshotControls" style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
      <select id="debtSnapshotSelect"
              style="flex:1; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;"></select>

      <input id="debtSnapshotInput"
             inputmode="decimal"
             placeholder="$0.00"
             oninput="autoFormatCurrencyInput(this)"
             onblur="finalizeCurrencyInput(this)"
             style="width:160px; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;" />

    <button class="confirmBtn"
      onclick="saveDebtSnapshotValue()"
      style="width:auto;">
      SAVE
    </button>
 
    </div>

    <div class="list" id="debtSnapshotList"></div>
  </div>

</div>
<!-- ===== END DEBT SNAPSHOT PAGE ===== -->

<!-- ===== BEGIN MONTHLY BILLS PAGE ===== -->
<div class="container page" id="pageBills" style="display:none;">

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-weight:800;">Monthly Bills</div>
      <button class="cancelBtn" onclick="navigateTo('home')" style="width:auto; padding:10px 12px;">BACK</button>
    </div>

    <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
      <select id="billsPageMonthSelect"
              style="flex:1; background:#0c131d; color:#fff; border:1px solid #1b2533; border-radius:12px; padding:14px;">
      </select>

      <button class="confirmBtn" onclick="renderBillsPage()" style="width:auto;">VIEW</button>
    </div>

    <div style="font-size:12px;color:#9aa7b6;margin-top:10px;">
      Toggle paid/unpaid. Set a paid date to override. Clearing paid date marks unpaid.
    </div>

    <div class="row" style="margin-top:14px;">
      <div>MONTH TOTAL</div>
      <div id="billsMonthTotal">$0</div>
    </div>

    <div class="row">
      <div>MONTH PAID</div>
      <div id="billsMonthPaid">$0</div>
    </div>

    <div class="row">
      <div>MONTH REMAINING</div>
      <div id="billsMonthRemaining">$0</div>
    </div>

    <div style="border-top:1px solid #1b2533; margin-top:14px; padding-top:14px;"></div>

    <div class="row">
      <div>DEBT PAYMENTS QUEUED</div>
      <div id="phaseDebtQueued">$0</div>
    </div>

    <div class="row">
      <div>PHASE REMAINING</div>
      <div id="phaseRemaining" style="font-weight:800;">$0</div>
    </div>

  </div>

  <div class="card">
    <div class="list" id="billsPageList"></div>
  </div>

</div>
<!-- ===== END MONTHLY BILLS PAGE ===== -->

<script>

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/* ===== BEGIN MONTHLY BILLS PERSISTENCE (REVERSIBLE) ===== */

function monthFromDate(dateStr){
  // expects YYYY-MM-DD
  if(!dateStr || dateStr.length < 7) return "";
  return dateStr.slice(0,7);
}

function currentMonthYYYYMM(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function billId(name, amount, dateStr){
  // Stable-ish ID: deterministic from fields
  const key = `${name}|${Number(amount).toFixed(2)}|${dateStr}`;
  let h = 0;
  for(let i=0;i<key.length;i++){
    h = ((h<<5)-h) + key.charCodeAt(i);
    h |= 0;
  }
  return `b_${Math.abs(h)}`;
}

function billsKey(month){
  return `bills_v1_${month}`;
}

function getBills(month){
  try{
    return JSON.parse(localStorage.getItem(billsKey(month)) || "[]");
  }catch{
    return [];
  }
}

function setBills(month, bills){
  localStorage.setItem(billsKey(month), JSON.stringify(bills));
}

// One-time import: if no stored bills for the month, read your hardcoded Home DOM bills into storage.
function importBillsFromDOMIfNeeded(month){
  const existing = getBills(month);
  if(existing.length) return;

  const list = document.getElementById("billsList");
  if(!list) return;

  const items = Array.from(list.querySelectorAll(":scope > .item"));

  const bills = items.map(el => {
    const name = (el.querySelector("div")?.textContent || "Bill").trim();
    const amount = Number(el.dataset.amount || 0);
    const dateStr = String(el.dataset.date || "");
    const m = monthFromDate(dateStr) || month;

  return {
    id: billId(name, amount, dateStr || `${m}-01`),
    name,
    amount,
    date: dateStr || `${m}-01`,   // treat as DUE date for now
    month: m,
    paid: false,
    paidAt: null                  // ✅ new
  };

  })
  .filter(b => b.month === month)
  .sort((a,b) => a.date.localeCompare(b.date));

  setBills(month, bills);
}

/* Home bills renderer: renders FROM storage, not DOM */
function renderHomeBills(month){
  const list = document.getElementById("billsList");
  if(!list) return;

  const bills = getBills(month).slice().sort((a,b)=>a.date.localeCompare(b.date));

  list.innerHTML = "";

  bills.forEach(b => {
    const item = document.createElement("div");
    item.className = `item${b.paid ? " paid" : ""}`;
    item.dataset.amount = String(b.amount);
    item.dataset.date = b.date;
    item.dataset.billId = b.id;
    item.dataset.paid = b.paid ? "true" : "false";

    // Tap row to open confirm bar (reuses your existing toggleConfirm)
    item.onclick = function(){ toggleConfirm(item); };

    item.innerHTML = `
      <div>${escapeHtml(b.name)}</div>
      <div>${fmtMoney(b.amount)}</div>
      <div class="confirmBar">
        <button class="confirmBtn" onclick="toggleBillPaid(event,this)">
          ${b.paid ? "↩ MARK UNPAID" : "✔ CONFIRM PAID"}
        </button>
        <button class="cancelBtn" onclick="cancelConfirm(event,this)">CANCEL</button>
      </div>
    `;

    list.appendChild(item);
  });
}

/* Reversible toggle: paid <-> unpaid */
function toggleBillPaid(e, btn){
  e.stopPropagation();

  const item = btn.closest(".item");
  if(!item) return;

  const billIdVal = item.dataset.billId;
  const amt = Number(item.dataset.amount || 0);
  const dateStr = String(item.dataset.date || "");
  const month = monthFromDate(dateStr);

  if(!month){
    alert("Bill missing data-date (YYYY-MM-DD). Add it so we can file it by month.");
    return;
  }

  const bills = getBills(month);
  const idx = bills.findIndex(b => b.id === billIdVal);
  if(idx < 0) return;

  if(!("paidAt" in bills[idx])) bills[idx].paidAt = null;

  const wasPaid = !!bills[idx].paid;
  bills[idx].paid = !wasPaid;

  // ✅ paid timestamp (posted/paid date)
  if(!wasPaid){
    bills[idx].paidAt = todayISO();  // marking paid now
  } else {
    bills[idx].paidAt = null;        // marking unpaid clears timestamp
  }

  setBills(month, bills);


  // Update cockpit totals reversibly
  const shouldEl = document.getElementById("shouldHave");
  const availEl  = document.getElementById("avail");
  if(shouldEl && availEl){
    let should = parseMoney(shouldEl.textContent);
    let avail  = parseMoney(availEl.textContent);

    if(!wasPaid){
      // marking paid
      should = should - amt;
      avail  = avail + amt;
    } else {
      // marking unpaid (reverse)
      should = should + amt;
      avail  = avail - amt;
    }

    shouldEl.textContent = fmtMoney(should);
    availEl.textContent  = fmtMoney(avail);
    updateStatus();
  }

  // Update UI row (no remove)
  item.classList.toggle("paid", !wasPaid);
  item.dataset.paid = (!wasPaid) ? "true" : "false";
  btn.textContent = (!wasPaid) ? "↩ MARK UNPAID" : "✔ CONFIRM PAID";

  // Refresh menu list if visible
  renderMonthlyBills();

  // refresh phase totals if Bills page is visible
  if(document.getElementById("pageBills")?.style.display !== "none"){
    renderBillsAndPhaseTotals(month);
  }
}

/* Menu drawer monthly bills list: render FROM storage */
function renderMonthlyBills(){
  const out = document.getElementById("monthlyBillsList");
  const sel = document.getElementById("billMonthSelect");
  if(!out || !sel) return;

  const month = sel.value; // "YYYY-MM"

  // Ensure month is initialized at least once
  importBillsFromDOMIfNeeded(month);

  const bills = getBills(month).slice().sort((a,b)=>a.date.localeCompare(b.date));

  out.innerHTML = "";
  bills.forEach(b => {
    const row = document.createElement("div");
    row.className = "item";
    row.style.cursor = "default";
    const paidTag = b.paid ? (b.paidAt ? ` ✅ (${b.paidAt})` : " ✅") : "";
    row.innerHTML = `<div>${b.date} • ${escapeHtml(b.name)}${paidTag}</div><div>${fmtMoney(b.amount)}</div>`;

    out.appendChild(row);
  });

  if(bills.length === 0){
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `<div>No bills found for ${month}</div><div></div>`;
    out.appendChild(row);
  }
}

/* ===== END MONTHLY BILLS PERSISTENCE (REVERSIBLE) ===== */



/* ===== BEGIN DEBT PAYMENTS STORAGE ===== */
const DEBT_PAYMENTS_KEY = "debt_payments_v1";

function getDebtPayments(){
  try{
    return JSON.parse(localStorage.getItem(DEBT_PAYMENTS_KEY) || "[]");
  }catch{
    return [];
  }
}

function setDebtPayments(arr){
  localStorage.setItem(DEBT_PAYMENTS_KEY, JSON.stringify(arr));
}
/* ===== END DEBT PAYMENTS STORAGE ===== */

/* ===== BEGIN AUTO CURRENCY FORMAT ===== */

// Format while typing (no forced decimals yet)
function autoFormatCurrencyInput(input){
  let raw = input.value;

  // Strip everything except digits and decimal
  raw = raw.replace(/[^0-9.]/g, "");

  // Prevent more than one decimal
  const parts = raw.split(".");
  if(parts.length > 2){
    raw = parts[0] + "." + parts.slice(1).join("");
  }

  // Format integer part with commas
  const [intPart, decPart] = raw.split(".");
  const intFormatted = intPart
    ? Number(intPart).toLocaleString()
    : "";

  input.value = decPart !== undefined
    ? `$${intFormatted}.${decPart}`
    : intFormatted ? `$${intFormatted}` : "";
}

// Finalize on blur (force 2 decimals)
function finalizeCurrencyInput(input){
  const num = parseMoney(input.value);
  if(!(num > 0)){
    input.value = "";
    return;
  }
  input.value = fmtMoney(num);
}

/* ===== END AUTO CURRENCY FORMAT ===== */


function updateBalance(){
  let val = prompt("Enter new balance:");
  if(!val) return;

  // Allow user to type with or without $ and commas
  const num = parseMoney(val);
  const balEl = document.getElementById("currentBalance");
  if(!balEl) return;

  balEl.textContent = fmtMoney(num);

  setLastUpdatedNow();
  updateStaleIndicator();
  updateStatus();

}
/* ===== BEGIN DEBT PAYMENTS (DROPDOWN + EDIT AMOUNT) ===== */

// 1) Put your card list here (copy names from your spreadsheet)
// Replace these placeholders with YOUR actual card names:
/* ===== BEGIN DEBT DROPDOWN OPTIONS (from your spreadsheet) ===== */
const DEBT_ACCOUNTS = [
  "USAA Signature Credit Card",
  "USAA Platinum Credit Card",
  "Amazon Prime Credit Card",
  "AMEX Platinum Card",
  "AMEX Blue Cash Credit Card",
  "AMEX Delta Credit Card",
  "AMEX Bonvoy Card",
  "Amazon Prime Business Credit Card",
];
/* ===== END DEBT DROPDOWN OPTIONS (from your spreadsheet) ===== */


/* ===== BEGIN DEBT PAYMENTS (PERSISTENT) ===== */

function showDebtForm(){
  const form = document.getElementById("debtForm");
  if(!form) return;
  form.style.display = "flex";
  document.getElementById("debtAmountInput")?.focus();
}

function hideDebtForm(){
  const form = document.getElementById("debtForm");
  if(!form) return;
  form.style.display = "none";
  const amt = document.getElementById("debtAmountInput");
  if(amt) amt.value = "";
}

function loadDebtPayments(){
  const debtList = document.getElementById("debtList");
  if(!debtList) return;

  debtList.innerHTML = "";
  const items = getDebtPayments();
  items.forEach(p => debtList.appendChild(renderDebtPaymentRow(p)));
}

function renderDebtPaymentRow(p){
  const item = document.createElement("div");
  item.className = "item";
  item.dataset.amount = String(p.amount);
  item.dataset.id = String(p.id);
  item.onclick = function(){ toggleConfirm(item); };

  item.innerHTML = `
    <div class="debtName">${escapeHtml(p.name)}</div>
    <div class="debtAmt">${fmtMoney(p.amount)}</div>

    <div class="confirmBar">
      <button class="confirmBtn" onclick="confirmDebtPaid(event,this)">✔ CONFIRM PAID</button>
      <button class="editBtn" onclick="editDebtAmount(event,this)">EDIT</button>
      <button class="cancelBtn" onclick="cancelConfirm(event,this)">CANCEL</button>
    </div>
  `;
  return item;
}

function addDebtPaymentFromForm(){
  const sel = document.getElementById("debtCardSelect");
  const amtInput = document.getElementById("debtAmountInput");
  const debtList = document.getElementById("debtList");
  if(!sel || !amtInput || !debtList) return;

  const name = sel.value?.trim();
  const amt = parseMoney(amtInput.value);

  if(!name){ alert("Pick a card/account."); return; }
  if(!(amt > 0)){ alert("Enter a valid positive amount."); return; }

  const payments = getDebtPayments();
  const p = { id: Date.now(), name, amount: amt };

  payments.unshift(p);
  setDebtPayments(payments);

  debtList.prepend(renderDebtPaymentRow(p));
  hideDebtForm();

  if(document.getElementById("pageBills")?.style.display !== "none"){
    const m = document.getElementById("billsPageMonthSelect")?.value || currentMonthYYYYMM();
    renderBillsAndPhaseTotals(m);
  }

}

function editDebtAmount(e, btn){
  e.stopPropagation();

  const item = btn.closest(".item");
  if(!item) return;

  const id = Number(item.dataset.id || 0);
  const current = Number(item.dataset.amount || 0);

  const nextStr = prompt("Edit payment amount:", fmtMoney(current));
  if(!nextStr) return;

  const next = parseMoney(nextStr);
  if(!(next > 0)){
    alert("Enter a valid positive amount.");
    return;
  }

  // update storage
  const payments = getDebtPayments().map(p => p.id === id ? { ...p, amount: next } : p);
  setDebtPayments(payments);

  // update UI
  item.dataset.amount = String(next);
  const amtEl = item.querySelector(".debtAmt");
  if(amtEl) amtEl.textContent = fmtMoney(next);

  // refresh phase totals if Bills page is visible
    if(document.getElementById("pageBills")?.style.display !== "none"){
    const m = document.getElementById("billsPageMonthSelect")?.value || currentMonthYYYYMM();
    renderBillsAndPhaseTotals(m);
  }

}



function confirmDebtPaid(e, btn){
  e.stopPropagation();

  const item = btn.closest(".item");
  if(!item) return;

  const amt = Number(item.dataset.amount || 0);
  const id  = Number(item.dataset.id || 0);

  // Update totals (Available for Debt down, Current Balance down)
  const availEl = document.getElementById("avail");
  const balEl   = document.getElementById("currentBalance");
  if(!availEl || !balEl) return;

  let avail = parseMoney(availEl.textContent);
  let bal   = parseMoney(balEl.textContent);

  avail -= amt;
  bal   -= amt;


  availEl.textContent = fmtMoney(avail);
  balEl.textContent   = fmtMoney(bal);
  updateStatus();

   // Remove from debt payments storage
  const payments = getDebtPayments().filter(p => p.id !== id);
  setDebtPayments(payments);

  // Optional: auto-apply to debt snapshot balance (Option C)
  if(getAutoApplyEnabled()){
    const nameEl = item.querySelector(".debtName");
    const debtName = nameEl ? nameEl.textContent.trim() : "";

    if(debtName){
      const balances = getDebtBalances();
      const currentOwed = Number(balances[debtName] || 0);
      const nextOwed = Math.max(0, currentOwed - amt);
      balances[debtName] = nextOwed;
      setDebtBalances(balances);

      // If you're currently on the Debt page, refresh it
      const debtPage = document.getElementById("pageDebt");
      if(debtPage && debtPage.style.display !== "none"){
        renderDebtSnapshotList();
        renderTotalDebtOwed(); 
        syncDebtSnapshotInput();
      }
    }

  }

// refresh phase totals if Bills page is visible
if(document.getElementById("pageBills")?.style.display !== "none"){
  const m = document.getElementById("billsPageMonthSelect")?.value || currentMonthYYYYMM();
  renderBillsAndPhaseTotals(m);
}

  // Animate + remove row
  item.classList.add("removing");
  setTimeout(()=>{ item.remove(); },230);
}

/* ===== END DEBT PAYMENTS (PERSISTENT) ===== */


// Tiny helper so user-entered names can’t break your HTML
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* ===== END DEBT PAYMENTS (DROPDOWN + EDIT AMOUNT) ===== */


function toggleConfirm(el){
  let bar = el.querySelector(".confirmBar");
  if(bar.style.display === "block") return;
  document.querySelectorAll(".confirmBar").forEach(b => b.style.display = "none");
  bar.style.display = "block";
}

function cancelConfirm(e,btn){
  e.stopPropagation();
  btn.closest(".confirmBar").style.display="none";
}


function parseMoney(str){
  return Number(String(str).replace(/[^0-9.-]/g,"")) || 0;
}
function fmtMoney(n){
  return n.toLocaleString(undefined,{style:"currency", currency:"USD"});
}

/* ===== BEGIN STATUS (SAFE/SHORTFALL) + DELTA ===== */
function updateStatus(){
  const shouldEl  = document.getElementById("shouldHave");
  const balEl     = document.getElementById("currentBalance");
  const statusEl  = document.getElementById("statusText");
  if(!shouldEl || !balEl || !statusEl) return;

  const should = parseMoney(shouldEl.textContent);
  const bal    = parseMoney(balEl.textContent);
  const delta  = bal - should;

  if(delta >= 0){
    statusEl.textContent = `SAFE (+${fmtMoney(delta)})`;
    statusEl.style.color = "#2bd576";
  } else {
    statusEl.textContent = `SHORTFALL (-${fmtMoney(Math.abs(delta))})`;
    statusEl.style.color = "#ff5c5c";
  }
}
/* ===== END STATUS (SAFE/SHORTFALL) + DELTA ===== */

/* ===== BEGIN DEBT SNAPSHOT MODEL (defaults + storage) ===== */

const DEBT_BALANCES_KEY = "debt_balances_v1";
const DEBT_AUTO_APPLY_KEY = "debt_auto_apply_v1";

// Store as POSITIVE amounts owed (we'll DISPLAY them as parentheses)
const DEFAULT_DEBT_BALANCES = {
  "House Mortgage": 550000.00,
  "Land Mortgage": 91750.34,
  "Tesla Loan": 30918.79,
  "Highlander Loan": 5781.08,
  "USAA Signature Credit Card": 4519.56,
  "USAA Platinum Credit Card": 0,
  "Amazon Prime Credit Card": 90.82,
  "AMEX Platinum Card": 0,
  "AMEX Blue Cash Credit Card": 178.57,
  "AMEX Delta Credit Card": 0,
  "AMEX Bonvoy Card": 1701.99,
  "Amazon Prime Business Credit Card": 1715.46
};

function getDebtBalances(){
  try{
    const stored = JSON.parse(localStorage.getItem(DEBT_BALANCES_KEY) || "null");
    if(stored && typeof stored === "object") return stored;
  }catch(e){}
  return { ...DEFAULT_DEBT_BALANCES };
}

function setDebtBalances(obj){
  localStorage.setItem(DEBT_BALANCES_KEY, JSON.stringify(obj));
}

function getAutoApplyEnabled(){
  return localStorage.getItem(DEBT_AUTO_APPLY_KEY) === "true";
}

function setAutoApplyEnabled(enabled){
  localStorage.setItem(DEBT_AUTO_APPLY_KEY, enabled ? "true" : "false");
}

function fmtOwed(n){
  const val = Number(n || 0);
  if(val <= 0) return "$-";
  // display like your sheet: $(550,000.00)
  return `$(${val.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})})`;
}

/* ===== END DEBT SNAPSHOT MODEL (defaults + storage) ===== */

function computeTotalDebtOwed(){
  const balances = getDebtBalances();
  return Object.values(balances).reduce((sum, v) => sum + Math.max(0, Number(v) || 0), 0);
}

function renderTotalDebtOwed(){
  const el = document.getElementById("totalDebtOwed");
  if(!el) return;
  el.textContent = fmtMoney(computeTotalDebtOwed());
}


/* ===== BEGIN DEBT SNAPSHOT PAGE LOGIC ===== */

function initDebtSnapshot(){
  // Initialize storage once
  if(!localStorage.getItem(DEBT_BALANCES_KEY)){
    setDebtBalances({ ...DEFAULT_DEBT_BALANCES });
  }

  const balances = getDebtBalances();

  const sel = document.getElementById("debtSnapshotSelect");
  const input = document.getElementById("debtSnapshotInput");
  const list = document.getElementById("debtSnapshotList");
  const toggle = document.getElementById("autoApplyToggle");

  if(!sel || !input || !list) return;

  // Toggle init
  if(toggle){
    toggle.checked = getAutoApplyEnabled();
  }

  // Populate dropdown
  sel.innerHTML = "";
  Object.keys(balances).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });

  sel.onchange = () => syncDebtSnapshotInput();
  renderDebtSnapshotList();
  renderTotalDebtOwed();
  syncDebtSnapshotInput();
}

function onToggleAutoApply(checked){
  setAutoApplyEnabled(checked);
}

function syncDebtSnapshotInput(){
  const sel = document.getElementById("debtSnapshotSelect");
  const input = document.getElementById("debtSnapshotInput");
  if(!sel || !input) return;

  const balances = getDebtBalances();
  const val = Number(balances[sel.value] || 0);

  // Input should be normal currency (no parentheses), so user can type easily
  input.value = val > 0 ? fmtMoney(val) : "";
}

function saveDebtSnapshotValue(){
  const sel = document.getElementById("debtSnapshotSelect");
  const input = document.getElementById("debtSnapshotInput");
  if(!sel || !input) return;

  const next = Math.max(0, parseMoney(input.value)); // allow 0
  const balances = getDebtBalances();
  balances[sel.value] = next;
  setDebtBalances(balances);

  renderDebtSnapshotList();
  renderTotalDebtOwed();
  syncDebtSnapshotInput();
}

function renderDebtSnapshotList(){
  const list = document.getElementById("debtSnapshotList");
  if(!list) return;

  const balances = getDebtBalances();
  const entries = Object.entries(balances);

  // Sort highest owed first
  entries.sort((a,b) => (b[1]||0) - (a[1]||0));

  list.innerHTML = "";
  entries.forEach(([name, val]) => {
    const row = document.createElement("div");
    row.className = "item";
    row.style.cursor = "pointer";
    row.onclick = () => {
      const sel = document.getElementById("debtSnapshotSelect");
      if(sel){
        sel.value = name;
        syncDebtSnapshotInput();
      }
    };
    row.innerHTML = `<div>${escapeHtml(name)}</div><div>${fmtOwed(val)}</div>`;
    list.appendChild(row);
  });
}

/* ===== END DEBT SNAPSHOT PAGE LOGIC ===== */


/* ===== BEGIN STALE BALANCE (UPDATED X AGO) ===== */
const LAST_UPDATED_KEY = "bills_lastUpdatedMs";
const STALE_HOURS = 6; // change this if you want (e.g., 12)

function setLastUpdatedNow(){
  localStorage.setItem(LAST_UPDATED_KEY, String(Date.now()));
}

function getLastUpdatedMs(){
  const raw = localStorage.getItem(LAST_UPDATED_KEY);
  const ms = raw ? Number(raw) : NaN;
  return Number.isFinite(ms) ? ms : NaN;
}

function formatAge(msAgo){
  const mins = Math.floor(msAgo / 60000);
  if(mins < 1) return "just now";
  if(mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if(hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}

function updateStaleIndicator(){
  const el = document.getElementById("updatedAgo");
  if(!el) return;

  const last = getLastUpdatedMs();
  if(!Number.isFinite(last)){
    el.textContent = "UPDATED —";
    el.style.color = "#9aa7b6";
    return;
  }

  const ageMs = Date.now() - last;
  const ageText = formatAge(ageMs);

  const stale = ageMs >= STALE_HOURS * 3600000;
  el.textContent = stale ? `UPDATED ${ageText} ⚠️` : `UPDATED ${ageText}`;
  el.style.color = stale ? "#f5b942" : "#9aa7b6";
}
/* ===== END STALE BALANCE (UPDATED X AGO) ===== */

/* ===== BEGIN MENU + MONTHLY BILLS ===== */

function toggleMenu(){
  const drawer = document.getElementById("menuDrawer");
  const back = document.getElementById("menuBackdrop");
  if(!drawer || !back) return;

  const open = drawer.style.display === "block";
  drawer.style.display = open ? "none" : "block";
  back.style.display = open ? "none" : "block";

  if(!open){
    // When opening, refresh snapshot + bills view
    renderMonthlyBills();
  }
}

/* ===== END MENU + MONTHLY BILLS ===== */

/* ===== BEGIN NAVIGATION ===== */
function showPage(pageId){
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  const page = document.getElementById(pageId);
  if(page) page.style.display = "block";
}

function navigateTo(dest){
  // Close menu if open
  const drawer = document.getElementById("menuDrawer");
  const back = document.getElementById("menuBackdrop");
  if(drawer && back){
    drawer.style.display = "none";
    back.style.display = "none";
  }

  if(dest === "home"){
    showPage("pageHome");
    return;
  }

  if(dest === "debt"){
    showPage("pageDebt");
    // Initialize snapshot if functions exist
    if(typeof initDebtSnapshot === "function") initDebtSnapshot();
    return;
  }

  if(dest === "bills"){
    showPage("pageBills");
    initBillsPage();
    return;
  }

}
/* ===== END NAVIGATION ===== */

/* ===== BEGIN MONTHLY BILLS PAGE LOGIC ===== */


// Ensure older stored bills don’t break
function normalizeBill(b){
  if(!("paid" in b)) b.paid = false;
  if(!("paidAt" in b)) b.paidAt = null; // new field
  return b;
}

// Keep cockpit numbers consistent even when toggling from Bills page
function applyBillDelta(amount, markingPaid){
  const shouldEl = document.getElementById("shouldHave");
  const availEl  = document.getElementById("avail");
  if(!shouldEl || !availEl) return;

  let should = parseMoney(shouldEl.textContent);
  let avail  = parseMoney(availEl.textContent);

  if(markingPaid){
    should = should - amount;
    avail  = avail + amount;
  } else {
    should = should + amount;
    avail  = avail - amount;
  }

  shouldEl.textContent = fmtMoney(should);
  availEl.textContent  = fmtMoney(avail);
  updateStatus();
}

function initBillsPage(){
  const sel = document.getElementById("billsPageMonthSelect");
  const menuSel = document.getElementById("billMonthSelect");
  if(!sel) return;

  // Copy month options from the menu dropdown (keeps it simple for now)
  sel.innerHTML = "";
  if(menuSel){
    Array.from(menuSel.options).forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.textContent;
      sel.appendChild(o);
    });
  }

  // Default to current month; add it if it’s missing
  const current = currentMonthYYYYMM();
  if(!Array.from(sel.options).some(o => o.value === current)){
    const o = document.createElement("option");
    o.value = current;
    o.textContent = current;
    sel.insertBefore(o, sel.firstChild);
  }
  sel.value = current;

  renderBillsPage();
}

function renderBillsPage(){
  const sel = document.getElementById("billsPageMonthSelect");
  const out = document.getElementById("billsPageList");
  if(!sel || !out) return;

  const month = sel.value;
  renderBillsAndPhaseTotals(month);

  importBillsFromDOMIfNeeded(month);

  let bills = getBills(month).map(normalizeBill);
  // persist any normalization upgrades
  setBills(month, bills);

  bills = bills.slice().sort((a,b)=> (a.date || "").localeCompare(b.date || ""));

  out.innerHTML = "";

  if(bills.length === 0){
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `<div>No bills found for ${month}</div><div></div>`;
    out.appendChild(row);
    return;
  }

  bills.forEach(b => {
    const row = document.createElement("div");
    row.className = `item${b.paid ? " paid" : ""}`;

    const paidDateVal = b.paidAt ? b.paidAt : "";

    row.innerHTML = `
      <div style="flex:1; padding-right:10px;">
        <div style="font-weight:800;">${escapeHtml(b.name)}</div>
        <div style="font-size:12px; color:#9aa7b6; margin-top:4px;">
          Due: ${escapeHtml(b.date || "—")}
        </div>
      </div>

      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:10px;">
        <div style="font-weight:800;">${fmtMoney(Number(b.amount || 0))}</div>

        <div class="billControls">
          <button class="billPaidBtn ${b.paid ? "paid" : ""}"
                  onclick="onBillPaidToggle('${b.id}', '${month}', ${!b.paid})">
            ${b.paid ? "✔ PAID" : "MARK PAID"}
          </button>


          <input type="date" value="${paidDateVal}" onchange="onBillPaidDateChange('${b.id}', '${month}', this.value)">
          <button class="miniBtn" onclick="clearBillPaidDate(event, '${b.id}', '${month}')">CLEAR</button>
        </div>
      </div>
    `;

    out.appendChild(row);
  });
}

function onBillPaidToggle(billIdVal, month, checked){
  const bills = getBills(month).map(normalizeBill);
  const idx = bills.findIndex(b => b.id === billIdVal);
  if(idx < 0) return;

  const wasPaid = !!bills[idx].paid;
  const amt = Number(bills[idx].amount || 0);

  // If no change, do nothing
  if(wasPaid === checked) return;

  bills[idx].paid = checked;

  // If toggling paid ON and no paidAt, default to today
  if(checked && !bills[idx].paidAt){
    bills[idx].paidAt = todayISO();
  }
  // If toggling paid OFF, clear paidAt
  if(!checked){
    bills[idx].paidAt = null;
  }

  setBills(month, bills);

  // Update cockpit numbers
  applyBillDelta(amt, checked);

  // Refresh views
  renderBillsPage();
  renderHomeBills(month);
  renderMonthlyBills();
}

function onBillPaidDateChange(billIdVal, month, dateVal){
  const bills = getBills(month).map(normalizeBill);
  const idx = bills.findIndex(b => b.id === billIdVal);
  if(idx < 0) return;

  const prevPaid = !!bills[idx].paid;
  const amt = Number(bills[idx].amount || 0);

  // Setting a date => Paid
  if(dateVal){
    bills[idx].paidAt = dateVal;
    bills[idx].paid = true;

    // If it was unpaid and now becomes paid, update cockpit
    if(!prevPaid){
      applyBillDelta(amt, true);
    }
  } else {
    // Date cleared via picker (rare). Treat as unpaid.
    bills[idx].paidAt = null;
    bills[idx].paid = false;

    if(prevPaid){
      applyBillDelta(amt, false);
    }
  }

  setBills(month, bills);

  renderBillsPage();
  renderHomeBills(month);
  renderMonthlyBills();
}

function clearBillPaidDate(e, billIdVal, month){
  e.stopPropagation();

  const bills = getBills(month).map(normalizeBill);
  const idx = bills.findIndex(b => b.id === billIdVal);
  if(idx < 0) return;

  const wasPaid = !!bills[idx].paid;
  const amt = Number(bills[idx].amount || 0);

  bills[idx].paidAt = null;
  bills[idx].paid = false;
  setBills(month, bills);

  if(wasPaid){
    applyBillDelta(amt, false);
  }

  renderBillsPage();
  renderHomeBills(month);
  renderMonthlyBills();
}

/* ===== END MONTHLY BILLS PAGE LOGIC ===== */

function computeBillsTotals(month){
  importBillsFromDOMIfNeeded(month);
  const bills = getBills(month).map(normalizeBill);

  let total = 0;
  let paid = 0;

  bills.forEach(b => {
    const amt = Number(b.amount || 0);
    total += amt;
    if(b.paid) paid += amt;
  });

  const remaining = Math.max(0, total - paid);
  return { total, paid, remaining };
}

function computeDebtQueuedTotal(){
  const items = getDebtPayments ? getDebtPayments() : [];
  return items.reduce((sum, p) => sum + Math.max(0, Number(p.amount || 0)), 0);
}

function renderBillsAndPhaseTotals(month){
  const t = computeBillsTotals(month);
  const debtQueued = computeDebtQueuedTotal();
  const phaseRemaining = t.remaining + debtQueued;

  const elTotal = document.getElementById("billsMonthTotal");
  const elPaid = document.getElementById("billsMonthPaid");
  const elRem = document.getElementById("billsMonthRemaining");
  const elDebt = document.getElementById("phaseDebtQueued");
  const elPhase = document.getElementById("phaseRemaining");

  if(elTotal) elTotal.textContent = fmtMoney(t.total);
  if(elPaid)  elPaid.textContent  = fmtMoney(t.paid);
  if(elRem)   elRem.textContent   = fmtMoney(t.remaining);
  if(elDebt)  elDebt.textContent  = fmtMoney(debtQueued);
  if(elPhase) elPhase.textContent = fmtMoney(phaseRemaining);
}


function restoreCarPaymentLabels(){
  const month = currentMonthYYYYMM();
  const bills = getBills(month);
  let changed = false;

  bills.forEach(b => {
    if(b.name === "Car Payment"){
      if(b.amount === 229.03) b.name = "Car Payment - Highlander";
      if(b.amount === 569.00) b.name = "Car Payment - Tesla";
      changed = true;
    }
  });

  if(changed){
    setBills(month, bills);
    renderHomeBills(month);
    renderBillsPage();
    renderMonthlyBills();
  }
}

function initDebtDropdown(){
  const sel = document.getElementById("debtCardSelect");
  if(!sel) return;

  sel.innerHTML = "";
  DEBT_ACCOUNTS.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  initDebtDropdown();
  loadDebtPayments();

  if(!Number.isFinite(getLastUpdatedMs())){
    setLastUpdatedNow();
  }

  updateStatus();
  updateStaleIndicator();
  setInterval(updateStaleIndicator, 60000);

  // Bills: persist + render from storage
  const month = currentMonthYYYYMM();
  importBillsFromDOMIfNeeded(month);
  renderHomeBills(month);
  restoreCarPaymentLabels();


  // If we load directly onto the Debt page, initialize snapshot
  if(document.getElementById("pageDebt")?.style.display !== "none"){
    initDebtSnapshot();
  }
});



</script>

</body>
</html>
